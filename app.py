import streamlit as st
import google.generativeai as genai

# 別ファイル（law_data.py）から、長い法律テキストを読み込む
try:
    from law_data import PROMPT_TEXT
except ImportError:
    # もしlaw_data.pyを作り忘れていてもエラーで落ちないようにする処置
    PROMPT_TEXT = "（法律データファイル law_data.py が見つかりませんでした。作成してください。）"

# ページ設定
st.set_page_config(page_title="いじめ対応支援AI", page_icon="🛡️")

st.title("🛡️ いじめ対応支援AIパートナー")
st.markdown("学校とのやり取りや相談内容を入力すると、**最新の法律・ガイドライン**に基づいた分析とアドバイスを行います。")

# サイドバー設定
with st.sidebar:
    st.header("ℹ️ 利用上の注意")
    st.warning("入力された内容はAIによる分析に使用されます。個人情報（実名や学校名など）は伏せて入力してください。")
    st.info("このAIは法的助言を行う弁護士ではありません。あくまで交渉のための参考情報として活用し、最終的な判断は専門家にご相談ください。")

# APIキーの設定
try:
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
except:
    st.error("APIキーが設定されていません。Streamlit CloudのSecretsを確認してください。")

# ---------------------------------------------------------
# システムプロンプト（AIへの命令）の構築
# ここで「基本の役割」と「law_data.pyの法律知識」を合体させます
# ---------------------------------------------------------
SYSTEM_INSTRUCTION = f"""
あなたは、いじめ被害児童とその家族を守るための「いじめ問題専門のアドバイザーAI」です。
ユーザー（保護者）は、学校や教育委員会の対応に疲弊し、助けを求めています。

以下の【判断基準となる法律・ガイドライン】の内容を完全に理解し、
それに照らし合わせて相談内容を分析してください。

【AIの振る舞い】
・常に「子どもの最善の利益（生命・安全）」を最優先してください。
・保護者に寄り添う、温かく落ち着いたトーンで話してください。
・しかし、分析部分は感情論ではなく、厳密に法律やガイドラインに基づいたロジカルな指摘をしてください。
・学校側の対応に法的な不備（義務違反、調査不足、放置、隠蔽の疑いなど）があれば、条文を引用して鋭く指摘してください。

【判断基準となる法律・ガイドライン（外部データ）】
{PROMPT_TEXT}

【出力フォーマット】
1. **現状の整理**
   - 相談内容から、重要な事実関係を整理します。

2. **法令・ガイドラインとの照合（違反・逸脱の疑い）**
   - 学校の対応のどの部分が、具体的にどの条文やガイドラインに反している可能性があるか指摘します。

3. **重大事態への該当性**
   - 法第28条の「重大事態」に該当する要素があるか分析します。

4. **推奨される次のアクション**
   - 保護者が次に取るべき行動（文書での質問、情報開示請求、教育委員会への通報など）を提案します。
"""

# ---------------------------------------------------------
# モデルの準備
# ※gemini-1.5-flashを使用（安定・高速・長文対応）
# ---------------------------------------------------------
model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    system_instruction=SYSTEM_INSTRUCTION
)

# ユーザー入力エリア
user_input = st.text_area("相談内容・学校の対応などを入力してください", height=300, placeholder="例：いじめられて不登校気味なのに、担任は「ただのふざけ合い」と言って取り合ってくれません。どうすればいいですか？")

# 分析ボタン
if st.button("分析を開始する", type="primary"):
    if user_input:
        with st.spinner("法律データと照らし合わせて分析中..."):
            try:
                # AIへの問い合わせ
                response = model.generate_content(
                    user_input,
                    generation_config={"temperature": 0.1} # 事実に即した回答にするため低めに設定
                )
                
                # 結果の表示
                st.markdown("---")
                st.markdown("### 📋 分析結果")
                st.write(response.text)
                
            except Exception as e:
                st.error(f"エラーが発生しました: {e}")
                st.info("※一時的な通信エラーの可能性があります。もう一度ボタンを押してみてください。")
    else:
        st.warning("相談内容を入力してください。")
