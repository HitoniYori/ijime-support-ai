import streamlit as st
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold

# law_data.py ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
try:
    from law_data import PROMPT_TEXT
except ImportError:
    PROMPT_TEXT = "ï¼ˆæ³•å¾‹ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« law_data.py ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼‰"

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="ã„ã˜ã‚å¯¾å¿œæ”¯æ´AI", page_icon="ğŸ›¡ï¸")

st.title("ğŸ›¡ï¸ ã„ã˜ã‚å¯¾å¿œæ”¯æ´AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼")
st.markdown("""
å­¦æ ¡ã‚„æ•™è‚²å§”å“¡ä¼šã®å¯¾å¿œã«ç–‘å•ã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ
ã‚ãªãŸã®çŠ¶æ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€**ã€Œæ³•å¾‹ã®ã©ã“ã«é•åã—ã¦ã„ã‚‹ã‹ã€**ã‚’ã€**è³‡æ–™åã¨ãƒšãƒ¼ã‚¸æ•°ä»˜ã**ã§å…·ä½“çš„ã«æ¡ˆå†…ã—ã¾ã™ã€‚
""")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
with st.sidebar:
    st.header("â„¹ï¸ åˆ©ç”¨ä¸Šã®æ³¨æ„")
    st.warning("å…¥åŠ›å†…å®¹ã¯AIã®åˆ†æã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚å€‹äººæƒ…å ±ï¼ˆå®Ÿåç­‰ï¼‰ã¯ä¼ã›ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    st.info("æç¤ºã•ã‚ŒãŸã€Œæ ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã€ã‚’ã‚¹ãƒãƒ›ã§è¦‹ã›ã‚‹ã‹ã€ãƒ¡ãƒ¢ã—ã¦å­¦æ ¡å´ã«ä¼ãˆã¦ãã ã•ã„ã€‚")

# APIã‚­ãƒ¼ã®è¨­å®š
try:
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
except:
    st.error("APIã‚­ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼ï¼šStreamlit Cloudã®Secretsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

# ==============================================================================
# 1. ãƒšãƒ¼ã‚¸æ•°ãƒ»URLå¯¾å¿œè¡¨
# ==============================================================================
REFERENCE_MAP = """
ã€é‡è¦è³‡æ–™ã®ãƒšãƒ¼ã‚¸æ•°ãƒ»URLå¯¾å¿œè¡¨ã€‘
AIã¯å›ç­”æ™‚ã«ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚ç…§ã—ã¦ã€Œè©²å½“ãƒšãƒ¼ã‚¸æ•°ã€ã‚’å¿…ãšæç¤ºã—ã¦ãã ã•ã„ã€‚

â– ã„ã˜ã‚ã®é‡å¤§äº‹æ…‹ã®èª¿æŸ»ã«é–¢ã™ã‚‹ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆä»¤å’Œ6å¹´8æœˆæ”¹è¨‚ç‰ˆï¼‰
[URL] https://www.mext.go.jp/content/20240821-mxt_jidou02-000037666_001.pdf
[ãƒšãƒ¼ã‚¸ç›®å®‰]
ãƒ»P.1  : å­¦æ ¡ã®åŸºæœ¬çš„å§¿å‹¢ï¼ˆã€Œéš è”½ã—ãªã„ã€ã€Œè²¬ä»»é€ƒã‚Œã—ãªã„ã€ï¼‰
ãƒ»P.2  : é‡å¤§äº‹æ…‹ã®å®šç¾©ï¼ˆç”Ÿå‘½å¿ƒèº«è²¡ç”£ã¸ã®è¢«å®³ï¼‰
ãƒ»P.3  : ä¸ç™»æ ¡é‡å¤§äº‹æ…‹ã®å®šç¾©ï¼ˆæ¬ å¸­30æ—¥ç›®å®‰ã€è»¢æ ¡ãƒ»é€€å­¦å«ã‚€ï¼‰
ãƒ»P.4  : ç™ºç”Ÿå ±å‘Šã®ç¾©å‹™ï¼ˆç›´ã¡ã«æ•™è‚²å§”å“¡ä¼šã¸å ±å‘Šï¼‰
ãƒ»P.5  : è¢«å®³å…ç«¥ç”Ÿå¾’ã®å®ˆç§˜ãƒ»å®‰å…¨ç¢ºä¿
ãƒ»P.6  : èª¿æŸ»çµ„ç¹”ã®è¨­ç½®ï¼ˆç¬¬ä¸‰è€…ã®å‚åŠ ã€å…¬å¹³æ€§ãƒ»ä¸­ç«‹æ€§ï¼‰
ãƒ»P.9  : èª¿æŸ»å‰ã®ä¿è­·è€…ã¸ã®èª¬æ˜ï¼ˆç›®çš„ãƒ»æ‰‹æ³•ã®åˆæ„å½¢æˆï¼‰
ãƒ»P.11 : èª¿æŸ»ã®å®Ÿæ–½ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã€è´ãå–ã‚Šï¼‰
ãƒ»P.15 : èª¿æŸ»çµæœã®èª¬æ˜ãƒ»å…¬è¡¨ï¼ˆé»’å¡—ã‚Šã¯æœ€å°é™ã«ã€å€‹äººæƒ…å ±ä¿è­·ã‚’ç›¾ã«ã—ãªã„ï¼‰
ãƒ»P.19 : å†èª¿æŸ»ï¼ˆç´å¾—ã§ããªã„å ´åˆã®å†èª¿æŸ»è¦å®šï¼‰

â– ã„ã˜ã‚é˜²æ­¢å¯¾ç­–æ¨é€²æ³•ï¼ˆæ¡æ–‡ï¼‰
[URL] https://elaws.e-gov.go.jp/document?lawid=425AC1000000071
[ãƒšãƒ¼ã‚¸ç›®å®‰]
ãƒ»æ¡æ–‡ã®ãŸã‚ãƒšãƒ¼ã‚¸æ•°ã§ã¯ãªãã€Œç¬¬ã€‡æ¡ã€ã¨æ¡ˆå†…ã™ã‚‹ã“ã¨ã€‚
ãƒ»ç¬¬22æ¡: å­¦æ ¡ã„ã˜ã‚å¯¾ç­–çµ„ç¹”ã®è¨­ç½®
ãƒ»ç¬¬23æ¡: é€šå ±ãƒ»äº‹å®Ÿç¢ºèªã®ç¾©å‹™
ãƒ»ç¬¬28æ¡: é‡å¤§äº‹æ…‹ã®èª¿æŸ»ç¾©å‹™

â– ã„ã˜ã‚ã®é˜²æ­¢ç­‰ã®ãŸã‚ã®åŸºæœ¬çš„ãªæ–¹é‡ï¼ˆå¹³æˆ29å¹´æ”¹å®šï¼‰
[URL] https://www.mext.go.jp/a_menu/shotou/seitoshidou/1340964.htm
[ãƒšãƒ¼ã‚¸ç›®å®‰]
ãƒ»P.3 : ã„ã˜ã‚ã®å®šç¾©ï¼ˆè¢«å®³è€…ã®ä¸»è¦³é‡è¦–ã€ã‘ã‚“ã‹ã‚‚å«ã‚€ï¼‰
ãƒ»P.12: ã„ã˜ã‚ã®è§£æ¶ˆå®šç¾©ï¼ˆè¡Œç‚ºãŒæ­¢ã‚“ã§3ãƒ¶æœˆ ï¼‹ å¿ƒèº«ã®è‹¦ç—›æ¶ˆå¤±ï¼‰
ãƒ»P.15: æ•™è·å“¡ã®æŠ±ãˆè¾¼ã¿ç¦æ­¢
"""

# ==============================================================================
# 2. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
#    â€»æ ç·šã®ç›´å¾Œã«ã€Œç©ºè¡Œã€ã‚’å…¥ã‚Œã‚‹ã‚ˆã†ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª¿æ•´ã—ã¾ã—ãŸ
# ==============================================================================
SYSTEM_INSTRUCTION = f"""
ã‚ãªãŸã¯ã€ã„ã˜ã‚è¢«å®³å…ç«¥ã¨ãã®å®¶æ—ã‚’å®ˆã‚‹ãŸã‚ã®ã€Œæ³•å‹™ãƒ»æ•™è‚²è¡Œæ”¿ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼AIã€ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¿è­·è€…ï¼‰ã¯ç²¾ç¥çš„ã«é™ç•Œã‚’è¿ãˆã¦ã„ã¾ã™ã€‚
ç´°ã‹ã„æ–‡å­—ã‚’èª­ã‚€ã®ã‚‚è¾›ã„çŠ¶æ³ã«ã‚ã‚‹ãŸã‚ã€**ã€Œã©ã®è³‡æ–™ã®ã€ä½•ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚Œã°ã„ã„ã‹ã€**ã‚’ä¸€ç›®ã§åˆ†ã‹ã‚‹ã‚ˆã†ã«**å¤§ããªæ ã§å›²ã£ã¦**è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
1. **å…±æ„Ÿ**: ä¿è­·è€…ã®è¾›ã„çŠ¶æ³ã«å¯„ã‚Šæ·»ã†ã€‚
2. **æ³•çš„æŒ‡æ‘˜**: å­¦æ ¡ã®å¯¾å¿œã®ä¸å‚™ã‚’æŒ‡æ‘˜ã™ã‚‹ã€‚
3. **è¦–è¦šçš„å¼·èª¿**: æ ¹æ‹ ã¨ãªã‚‹è³‡æ–™ã¨ãƒšãƒ¼ã‚¸æ•°ã‚’ã€ç½«ç·šã‚’ä½¿ã£ã¦å¤§ããè¡¨ç¤ºã™ã‚‹ã€‚

---
ã€å‚ç…§ã™ã¹ãæ³•å¾‹çŸ¥è­˜ (law_data.py)ã€‘
{PROMPT_TEXT}

ã€ãƒšãƒ¼ã‚¸æ•°ãƒ»URLãƒªã‚¹ãƒˆ (REFERENCE_MAP)ã€‘
{REFERENCE_MAP}
---

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã“ã®å½¢å¼ã‚’å³å®ˆã™ã‚‹ã“ã¨ï¼‰ã€‘

### 1. ç¾çŠ¶ã®æ•´ç†
ï¼ˆä¿è­·è€…ã®è©±ã‚’è¦ç´„ï¼‰

### 2. âš ï¸ æ³•ä»¤ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•åã®ç–‘ã„ãŒã‚ã‚‹ç‚¹

ï¼ˆä»¥ä¸‹ã‚’ã€é•åãƒã‚¤ãƒ³ãƒˆã”ã¨ã«ç¹°ã‚Šè¿”ã™ï¼‰

**æŒ‡æ‘˜â‘ ï¼šã€‡ã€‡ç¾©å‹™é•åã®ç–‘ã„**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“

ã€€ğŸ“– **æ ¹æ‹ ã¨ãªã‚‹è³‡æ–™**
ã€€**[ã“ã“ã«æ­£å¼ãªè³‡æ–™åã®ã¿ã‚’æ›¸ã]**

ã€€ğŸ“ **è©²å½“ç®‡æ‰€**
ã€€**ã€ P. ã€‡ã€‡ ã€‘** ï¼ˆã¾ãŸã¯ ç¬¬ã€‡æ¡ï¼‰

ã€€ğŸ”— **å…¥æ‰‹å…ˆURL**
ã€€[URLã‚’ã“ã“ã«æ›¸ã]

â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

> **æ¡æ–‡ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®å†…å®¹:**
> ã€Œ......ï¼ˆé‡è¦ãªéƒ¨åˆ†ã‚’å¼•ç”¨ï¼‰......ã€

**è§£èª¬:**
å­¦æ ¡å´ã¯ã“ã†è¨€ã£ã¦ã„ã¾ã™ãŒã€ã“ã®è³‡æ–™ã® P.ã€‡ã€‡ ã«ã¯æ˜ç¢ºã«ã“ã†æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ï¼ˆæŒ‡æ‘˜â‘¡ãŒã‚ã‚Œã°ç¶šã...ï¼‰

### 3. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ï¼ˆä¿è­·è€…ã¸ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰
"""

# ==============================================================================
# 3. ã‚¢ãƒ—ãƒªå®Ÿè¡Œéƒ¨åˆ†
# ==============================================================================

# å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è§£é™¤
safety_settings = {
    HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
}

model = genai.GenerativeModel(
    model_name="gemini-flash-latest",
    system_instruction=SYSTEM_INSTRUCTION
)

user_input = st.text_area("ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", height=300, 
    placeholder="ä¾‹ï¼šå­ä¾›ãŒã„ã˜ã‚ã§ä¸ç™»æ ¡ã§ã™ãŒã€å­¦æ ¡ã¯ã€Œé‡å¤§äº‹æ…‹ã§ã¯ãªã„ã€ã¨è¨€ã£ã¦èª¿æŸ»ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ã©ã“ã‚’è¦‹ã›ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ")

if st.button("ãƒšãƒ¼ã‚¸æ•°ä»˜ãã§åˆ†æã™ã‚‹", type="primary"):
    if user_input:
        with st.spinner("è³‡æ–™ã®ãƒšãƒ¼ã‚¸æ•°ã‚’ç¢ºèªä¸­..."):
            try:
                response = model.generate_content(
                    user_input,
                    generation_config={"temperature": 0.0},
                    safety_settings=safety_settings
                )
                
                if response.text:
                    st.markdown("---")
                    st.markdown("### ğŸ“‹ åˆ†æçµæœ")
                    st.write(response.text)
                    st.markdown("---")
                    st.success("ğŸ’¡ **ä½¿ã„æ–¹:** æ ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ï¼ˆè³‡æ–™åã¨ãƒšãƒ¼ã‚¸æ•°ï¼‰ã‚’ã€ãã®ã¾ã¾å­¦æ ¡ã®å…ˆç”Ÿã«è¦‹ã›ã¦ãã ã•ã„ã€‚ã€Œã“ã“ã«ã“ã†æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€ã¨ä¼ãˆã‚‹ãŸã‚ã®ãƒ¡ãƒ¢ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚")
                else:
                    st.error("AIãŒå›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")

            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    else:
        st.warning("ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
