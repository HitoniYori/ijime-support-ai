import streamlit as st
import google.generativeai as genai

# 別ファイル（law_data.py）から、長い法律テキストを読み込む
try:
    from law_data import PROMPT_TEXT
except ImportError:
    PROMPT_TEXT = "（法律データファイル law_data.py が見つかりませんでした。）"

# ページ設定
st.set_page_config(page_title="いじめ対応支援AI", page_icon="🛡️")

st.title("🛡️ いじめ対応支援AIパートナー")
st.markdown("""
学校や教育委員会の対応に疑問を感じていませんか？
あなたの状況を入力すると、**法律やガイドラインの「どこ」に違反している可能性があるか**、根拠となる条文と資料の入手先を提示します。
""")

# サイドバー設定
with st.sidebar:
    st.header("ℹ️ 利用上の注意")
    st.warning("入力内容はAIの分析に使用されます。個人情報（実名等）は伏せて入力してください。")
    st.info("このAIは法的助言を行う弁護士ではありません。提示された条文や資料を武器に、専門家（弁護士等）へ相談することをお勧めします。")

# APIキーの設定
try:
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
except:
    st.error("APIキー設定エラー：Streamlit CloudのSecretsを確認してください。")

# ==============================================================================
# 1. 資料の入手先リスト（AIに教えるURLリスト）
# ==============================================================================
REFERENCE_URLS = """
【資料の入手先リスト】
AIは回答時に、以下のURLを参照元として提示してください。

1. **いじめ防止対策推進法（全文）**
   - 入手先: e-Gov法令検索
   - URL: https://elaws.e-gov.go.jp/document?lawid=425AC1000000071

2. **いじめの防止等のための基本的な方針（文部科学省）**
   - 入手先: 文部科学省 公式サイト
   - URL: https://www.mext.go.jp/a_menu/shotou/seitoshidou/1340964.htm

3. **いじめの重大事態の調査に関するガイドライン（令和6年8月改訂）**
   - 入手先: 文部科学省 公式サイト
   - URL: https://www.mext.go.jp/content/20240821-mxt_jidou02-000037666_001.pdf

4. **生徒指導提要（改訂版）**
   - 入手先: 文部科学省 公式サイト（デジタルテキスト）
   - URL: https://www.mext.go.jp/a_menu/shotou/seitoshidou/1407733.htm
"""

# ==============================================================================
# 2. システムプロンプト（AIへの命令書）
#    ここを工夫して「根拠」を出させるようにします
# ==============================================================================
SYSTEM_INSTRUCTION = f"""
あなたは、いじめ被害児童とその家族を守るための「いじめ問題専門の法務アシスタントAI」です。
ユーザー（保護者）の訴えを聞き、学校側の対応が**「どの法律・ガイドラインの、どの条文に違反している疑いがあるか」**を特定して指摘してください。

【あなたの役割】
1. **共感と整理**: まず保護者の辛い気持ちを受け止め、事実関係を整理する。
2. **法的チェック**: 学校の対応（または無対応）が、法律やガイドラインのどこに抵触するかを厳密に判定する。
3. **根拠の提示**: 指摘する際は、必ず「資料名」「条文番号」「実際の引用」「入手URL」をセットで提示する。

---
【参照すべき知識データ（law_data.pyより）】
{PROMPT_TEXT}

【資料のURLリスト】
{REFERENCE_URLS}
---

【出力フォーマット（必ずこの形式で回答すること）】

### 1. 現状の分析
（保護者の話を要約し、学校側の問題点と思われる箇所を洗い出す）

### 2. ⚠️ 法令・ガイドライン違反の疑いがある点
（ここが最も重要です。以下の形式で、該当する箇所を全て挙げてください）

**指摘ポイント①：〇〇義務違反の疑い**
> **根拠資料:** [資料名をここに書く]
> **該当条文:** [第〇条 第〇項 など]
> **条文の内容:** 「......（重要な部分を抜粋）......」
> **解説:** 学校側は「～～」と言っていますが、この条文では「～～」と定められています。したがって、学校の対応は不適切である可能性があります。
> **資料入手先:** [URLをここに貼る]

（違反疑いがある点が複数ある場合は、ポイント②、③...と続ける）

### 3. 重大事態への該当性チェック
（法第28条の「生命心身財産重大事態」または「不登校重大事態」に当てはまるか分析）

### 4. 次に取るべき具体的アクション
（「この条文を印刷して、校長にこう伝えてください」など、具体的な行動を提案）
"""

# ==============================================================================
# 3. アプリの画面構成
# ==============================================================================
model = genai.GenerativeModel(
    model_name="gemini-flash-latest",
    system_instruction=SYSTEM_INSTRUCTION
)

user_input = st.text_area("相談内容・学校の対応などを詳しく入力してください", height=300, 
    placeholder="例：\n子供がいじめで不登校（欠席40日目）になっています。\n担任に調査をお願いしましたが、「ただの喧嘩だから調査はしない」と言われました。\nこれは法律違反ではないですか？")

if st.button("法律に基づいて分析する", type="primary"):
    if user_input:
        with st.spinner("🔍 法律・ガイドラインと照合中..."):
            try:
                response = model.generate_content(
                    user_input,
                    generation_config={"temperature": 0.0} # 法律に基づき厳格に回答させるため0にする
                )
                st.markdown("---")
                st.markdown("### 📋 分析レポート")
                st.write(response.text)
                
                st.markdown("---")
                st.info("💡 **アドバイス:** 上記の「根拠資料」のURLからPDFをダウンロード・印刷し、該当する条文にマーカーを引いて学校との話し合いに持参することをお勧めします。")
                
            except Exception as e:
                st.error(f"エラーが発生しました: {e}")
    else:
        st.warning("相談内容を入力してください。")
